<?php

use Illuminate\Support\Facades\Route;
use App\Http\Controllers\EmployeeController;
use App\Http\Controllers\BranchController;
use App\Http\Controllers\DepartmentController;
use App\Http\Controllers\DashboardController;

/*
|--------------------------------------------------------------------------
| Web Routes - Employee Management System v2.1 (Web Interface Only)
|--------------------------------------------------------------------------
| NOTE: API routes are now handled in routes/api.php
| This file contains only web interface routes
*/

// ✅ Dashboard Routes (แก้ไขให้ใช้ DashboardController)
Route::middleware(['auth'])->group(function () {
    Route::get('/dashboard', [DashboardController::class, 'index'])->name('dashboard');
    Route::get('/dashboard/stats', [DashboardController::class, 'getStats'])->name('dashboard.stats');
    Route::get('/dashboard/role-data', [DashboardController::class, 'getRoleData'])->name('dashboard.role-data');
    Route::get('/dashboard/notifications', [DashboardController::class, 'getNotifications'])->name('dashboard.notifications');
    
    // Redirect root to dashboard
    Route::get('/', function () {
        return redirect()->route('dashboard');
    })->name('home');
});

// ✅ Main Employee Routes (Web Interface Only)
Route::prefix('employees')->middleware(['auth'])->group(function () {
    
    // ✅ List & Search
    Route::get('/', [EmployeeController::class, 'index'])
         ->middleware('role:super_admin,it_admin,hr,manager,express')
         ->name('employees.index');
    
    // ✅ Create
    Route::get('/create', [EmployeeController::class, 'create'])
         ->middleware('role:super_admin,it_admin,hr')
         ->name('employees.create');
         
    Route::post('/', [EmployeeController::class, 'store'])
         ->middleware('role:super_admin,it_admin,hr')
         ->name('employees.store');
    
    // ✅ Show Individual Employee
    Route::get('/{employee}', [EmployeeController::class, 'show'])
         ->name('employees.show');
    
    // ✅ Edit Individual Employee
    Route::get('/{employee}/edit', [EmployeeController::class, 'edit'])
         ->middleware('role:super_admin,it_admin,hr')
         ->name('employees.edit');
         
    Route::put('/{employee}', [EmployeeController::class, 'update'])
         ->middleware('role:super_admin,it_admin,hr')
         ->name('employees.update');
    
    // ✅ Delete Individual Employee (Soft Delete)
    Route::delete('/{employee}', [EmployeeController::class, 'destroy'])
         ->middleware('role:super_admin')
         ->name('employees.destroy');
    
    // ✅ Trash Management (Super Admin Only)
    Route::prefix('trash')->middleware('role:super_admin')->group(function () {
        Route::get('/', [EmployeeController::class, 'trash'])
             ->name('employees.trash');
             
        Route::patch('/{id}/restore', [EmployeeController::class, 'restore'])
             ->name('employees.restore');
             
        Route::delete('/{id}/force', [EmployeeController::class, 'forceDelete'])
             ->name('employees.force-delete');
             
        Route::delete('/empty', [EmployeeController::class, 'emptyTrash'])
             ->name('employees.empty-trash');
    });
    
    // ✅ Export Routes
    Route::get('/export/excel', [EmployeeController::class, 'exportExcel'])->name('employees.export.excel');
    Route::get('/export/pdf', [EmployeeController::class, 'exportPdf'])->name('employees.export.pdf');
    Route::get('/export/csv', [EmployeeController::class, 'exportCsv'])->name('employees.export.csv');
    
    // ✅ Bulk Operations
    Route::post('/bulk/delete', [EmployeeController::class, 'bulkDelete'])->name('employees.bulk.delete');
    Route::post('/bulk/restore', [EmployeeController::class, 'bulkRestore'])->name('employees.bulk.restore');
    Route::post('/bulk/permanent-delete', [EmployeeController::class, 'bulkPermanentDelete'])
         ->middleware('role:super_admin')
         ->name('employees.bulk.permanent-delete');
});

// ✅ Department Routes (Web Interface)
Route::prefix('departments')->middleware(['auth', 'role:super_admin,it_admin'])->group(function () {
    Route::get('/', [DepartmentController::class, 'index'])->name('departments.index');
    Route::get('/create', [DepartmentController::class, 'create'])->name('departments.create');
    Route::post('/', [DepartmentController::class, 'store'])->name('departments.store');
    Route::get('/{department}', [DepartmentController::class, 'show'])->name('departments.show');
    Route::get('/{department}/edit', [DepartmentController::class, 'edit'])->name('departments.edit');
    Route::put('/{department}', [DepartmentController::class, 'update'])->name('departments.update');
    Route::delete('/{department}', [DepartmentController::class, 'destroy'])->name('departments.destroy');
    
    // Department Trash
    Route::get('/trash', [DepartmentController::class, 'trash'])->name('departments.trash');
    Route::patch('/{id}/restore', [DepartmentController::class, 'restore'])->name('departments.restore');
    Route::delete('/{id}/force', [DepartmentController::class, 'forceDelete'])->name('departments.force-delete');
    
    // Department Export
    Route::get('/export/excel', [DepartmentController::class, 'exportExcel'])->name('departments.export.excel');
    Route::get('/export/pdf', [DepartmentController::class, 'exportPdf'])->name('departments.export.pdf');
});

// ✅ Branch Routes (Web Interface) - แก้ไขเพิ่ม toggle-status route ที่หายไป
Route::prefix('branches')->middleware(['auth', 'role:super_admin,it_admin,hr'])->group(function () {
    Route::get('/', [BranchController::class, 'index'])->name('branches.index');
    Route::get('/create', [BranchController::class, 'create'])->name('branches.create');
    Route::post('/', [BranchController::class, 'store'])->name('branches.store');
    Route::get('/{branch}', [BranchController::class, 'show'])->name('branches.show');
    Route::get('/{branch}/edit', [BranchController::class, 'edit'])->name('branches.edit');
    Route::put('/{branch}', [BranchController::class, 'update'])->name('branches.update');
    Route::delete('/{branch}', [BranchController::class, 'destroy'])->name('branches.destroy');
    
    // ✅ FIXED: เพิ่ม toggle-status route ที่หายไป
    Route::patch('/{branch}/toggle-status', [BranchController::class, 'toggleStatus'])->name('branches.toggle-status');
    
    // Branch Trash
    Route::get('/trash', [BranchController::class, 'trash'])->name('branches.trash');
    Route::patch('/{id}/restore', [BranchController::class, 'restore'])->name('branches.restore');
    Route::delete('/{id}/force', [BranchController::class, 'forceDelete'])->name('branches.force-delete');
    
    // Branch Export Routes
    Route::get('/export/excel', [BranchController::class, 'exportExcel'])->name('branches.export.excel');
    Route::get('/export/pdf', [BranchController::class, 'exportPdf'])->name('branches.export.pdf');
    Route::get('/export/csv', [BranchController::class, 'exportCsv'])->name('branches.export.csv');
    
    // ✅ FIXED: แก้ไข export route สำหรับ dashboard quick action
    Route::get('/export', [BranchController::class, 'exportExcel'])->name('branches.export');
    
    // Branch AJAX/API Routes
    Route::get('/data', [BranchController::class, 'getData'])->name('branches.data');
});

// ✅ Authentication Routes
require __DIR__.'/auth.php';

// ✅ Health Check Route (Web Only)
Route::get('/health', function () {
    try {
        // ตรวจสอบการเชื่อมต่อฐานข้อมูล
        \DB::connection()->getPdo();
        $dbStatus = 'connected';
    } catch (\Exception $e) {
        $dbStatus = 'disconnected';
    }
    
    return response()->json([
        'status' => 'ok',
        'timestamp' => now(),
        'laravel_version' => app()->version(),
        'php_version' => PHP_VERSION,
        'environment' => app()->environment(),
        'routes_cached' => app()->routesAreCached(),
        'config_cached' => app()->configurationIsCached(),
        'database_status' => $dbStatus,
        'memory_usage' => round(memory_get_usage(true) / 1024 / 1024, 2) . ' MB',
        'note' => 'ITMS Employee Management System v2.1 - Web routes only'
    ]);
})->name('health.check');

// ✅ Development Routes (เฉพาะ local environment)
if (app()->environment('local', 'development')) {
    Route::prefix('dev')->middleware(['auth', 'role:super_admin'])->group(function () {
        Route::get('/clear-cache', function () {
            \Artisan::call('cache:clear');
            \Artisan::call('config:clear');
            \Artisan::call('route:clear');
            \Artisan::call('view:clear');
            return 'Cache cleared successfully!';
        })->name('dev.clear-cache');
        
        Route::get('/routes', function () {
            $routes = \Route::getRoutes();
            $routeList = [];
            foreach ($routes as $route) {
                $routeList[] = [
                    'method' => implode('|', $route->methods()),
                    'uri' => $route->uri(),
                    'name' => $route->getName(),
                    'action' => $route->getActionName()
                ];
            }
            return response()->json($routeList);
        })->name('dev.routes');
    });
}

// ✅ Fallback for 404
Route::fallback(function () {
    return redirect()->route('dashboard')->with('error', 'หน้าที่คุณต้องการไม่พบในระบบ');
});
