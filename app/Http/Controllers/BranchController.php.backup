<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\Branch;
use App\Models\Employee; // âœ… FIXED: à¹ƒà¸Šà¹‰ Employee à¹à¸—à¸™ User
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Log;

class BranchController extends Controller
{
    public function __construct()
    {
        $this->middleware(['auth']);
        // Remove role middleware for testing
        // $this->middleware(['auth', 'role:super_admin,admin']);
    }

    /**
     * Display a listing of branches
     */
    public function index(Request $request)
    {
        $query = Branch::with(['manager', 'employees']);

        // Search functionality
        if ($request->has('search') && $request->search) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('name', 'LIKE', "%{$search}%")
                  ->orWhere('code', 'LIKE', "%{$search}%")
                  ->orWhere('address', 'LIKE', "%{$search}%");
            });
        }

        // Status filter
        if ($request->has('status') && $request->status !== '') {
            $query->where('is_active', $request->status);
        }

        $branches = $query->orderBy('name')->paginate(10);

        return view('branches.index', compact('branches'));
    }

    /**
     * Show the form for creating a new branch
     */
    public function create()
    {
        // âœ… FIXED: Get employees who can be managers (using Employee model)
        $availableManagers = Employee::whereNull('branch_id') // âœ… à¹ƒà¸Šà¹‰ branch_id à¹à¸—à¸™ managed_branch_id
            ->where('status', 'active') // âœ… à¹ƒà¸Šà¹‰ status à¹à¸—à¸™ is_active
            ->whereIn('role', ['manager', 'super_admin', 'it_admin']) // âœ… à¹€à¸‰à¸à¸²à¸° role à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
            ->orderBy('first_name_th')
            ->orderBy('last_name_th')
            ->get();

        return view('branches.create', compact('availableManagers'));
    }

    /**
     * Store a newly created branch
     */
    public function store(Request $request)
    {
        Log::info('=== Branch Store Debug ===');
        Log::info('Request Data:', $request->all());

        try {
            // Validation
            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'code' => 'required|string|max:10|unique:branches,code',
                'description' => 'nullable|string',
                'address' => 'nullable|string',
                'phone' => 'nullable|string|max:20',
                'email' => 'nullable|email|max:255',
                'manager_id' => 'nullable|exists:employees,id', // âœ… FIXED: à¹ƒà¸Šà¹‰ employees table
                'is_active' => 'nullable',
                'capacity' => 'nullable|integer|min:1|max:1000', // âœ… à¹€à¸à¸´à¹ˆà¸¡ capacity
                'area_sqm' => 'nullable|numeric|min:0|max:99999.99', // âœ… à¹€à¸à¸´à¹ˆà¸¡ area_sqm
                'opening_date' => 'nullable|date|before_or_equal:today', // âœ… à¹€à¸à¸´à¹ˆà¸¡ opening_date
            ]);

            Log::info('Validation Passed:', $validated);

            // Handle checkbox - if not checked, it won't be in request
            $validated['is_active'] = $request->has('is_active');

            // Create branch
            $branch = Branch::create($validated);

            Log::info('Branch Created:', $branch->toArray());

            // âœ… FIXED: Update manager's branch_id if manager is assigned
            if ($request->manager_id) {
                Employee::where('id', $request->manager_id)->update([
                    'branch_id' => $branch->id // âœ… à¹ƒà¸Šà¹‰ branch_id à¹à¸—à¸™ managed_branch_id
                ]);
                Log::info('Manager Updated:', ['manager_id' => $request->manager_id, 'branch_id' => $branch->id]);
            }

            return redirect()->route('branches.index')
                ->with('success', 'à¸ªà¸£à¹‰à¸²à¸‡à¸ªà¸²à¸‚à¸²à¹ƒà¸«à¸¡à¹ˆà¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');

        } catch (\Illuminate\Validation\ValidationException $e) {
            Log::error('Validation Error:', $e->errors());
            return back()->withErrors($e->errors())->withInput();
        } catch (\Exception $e) {
            Log::error('Branch Store Error:', ['error' => $e->getMessage(), 'trace' => $e->getTraceAsString()]);
            return back()->withErrors(['error' => 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' . $e->getMessage()])->withInput();
        }
    }

    /**
     * Display the specified branch
     */
    public function show(Branch $branch)
    {
        $branch->load(['manager', 'employees']);
        
        // âœ… FIXED: Get branch statistics
        $statistics = [
            'total_employees' => $branch->employees()->count(),
            'active_employees' => $branch->employees()->where('status', 'active')->count(), // âœ… à¹ƒà¸Šà¹‰ status
            'departments' => $branch->employees()->with('department')->get()->pluck('department.name')->unique()->filter()->values(),
            'capacity_info' => $branch->getCapacityInfo(), // âœ… à¹ƒà¸Šà¹‰ method à¸ˆà¸²à¸ Model
        ];

        return view('branches.show', compact('branch', 'statistics'));
    }

    /**
     * Show the form for editing the specified branch
     */
    public function edit(Branch $branch)
    {
        // âœ… FIXED: Get available managers (including current manager)
        $availableManagers = Employee::where(function($query) use ($branch) {
            $query->whereNull('branch_id') // âœ… à¹ƒà¸Šà¹‰ branch_id
                  ->orWhere('id', $branch->manager_id);
        })
        ->where('status', 'active') // âœ… à¹ƒà¸Šà¹‰ status
        ->whereIn('role', ['manager', 'super_admin', 'it_admin']) // âœ… à¹€à¸‰à¸à¸²à¸° role à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
        ->orderBy('first_name_th')
        ->orderBy('last_name_th')
        ->get();

        return view('branches.edit', compact('branch', 'availableManagers'));
    }

    /**
     * Update the specified branch
     */
    public function update(Request $request, Branch $branch)
    {
        Log::info('=== Branch Update Debug ===');
        Log::info('Request Data:', $request->all());

        try {
            // Validation
            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'code' => 'required|string|max:10|unique:branches,code,' . $branch->id,
                'description' => 'nullable|string',
                'address' => 'nullable|string',
                'phone' => 'nullable|string|max:20',
                'email' => 'nullable|email|max:255',
                'manager_id' => 'nullable|exists:employees,id', // âœ… FIXED
                'is_active' => 'nullable',
                'capacity' => 'nullable|integer|min:1|max:1000',
                'area_sqm' => 'nullable|numeric|min:0|max:99999.99',
                'opening_date' => 'nullable|date|before_or_equal:today',
            ]);

            // Handle checkbox
            $validated['is_active'] = $request->has('is_active');

            // âœ… FIXED: Remove branch_id from old manager
            if ($branch->manager_id && $branch->manager_id != $request->manager_id) {
                Employee::where('id', $branch->manager_id)->update([
                    'branch_id' => null // âœ… à¹ƒà¸Šà¹‰ branch_id
                ]);
            }

            // Update branch
            $branch->update($validated);

            // âœ… FIXED: Set branch_id for new manager
            if ($request->manager_id) {
                Employee::where('id', $request->manager_id)->update([
                    'branch_id' => $branch->id // âœ… à¹ƒà¸Šà¹‰ branch_id
                ]);
            }

            return redirect()->route('branches.index')
                ->with('success', 'à¸­à¸±à¸à¹€à¸”à¸•à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');

        } catch (\Exception $e) {
            Log::error('Branch Update Error:', ['error' => $e->getMessage()]);
            return back()->withErrors(['error' => 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”: ' . $e->getMessage()])->withInput();
        }
    }

    /**
     * Remove the specified branch
     */
    public function destroy(Branch $branch)
    {
        try {
            // Check if branch has employees
            if ($branch->employees()->count() > 0) {
                return redirect()->route('branches.index')
                    ->with('error', 'à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸šà¸ªà¸²à¸‚à¸²à¸—à¸µà¹ˆà¸¡à¸µà¸à¸™à¸±à¸à¸‡à¸²à¸™à¸­à¸¢à¸¹à¹ˆà¹„à¸”à¹‰');
            }

            // âœ… FIXED: Remove branch_id from manager
            if ($branch->manager_id) {
                Employee::where('id', $branch->manager_id)->update([
                    'branch_id' => null // âœ… à¹ƒà¸Šà¹‰ branch_id
                ]);
            }

            $branch->delete();

            return redirect()->route('branches.index')
                ->with('success', 'à¸¥à¸šà¸ªà¸²à¸‚à¸²à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§');

        } catch (\Exception $e) {
            Log::error('Branch Delete Error:', ['error' => $e->getMessage()]);
            return redirect()->route('branches.index')
                ->with('error', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸¥à¸šà¸ªà¸²à¸‚à¸²: ' . $e->getMessage());
        }
    }

    /**
     * Toggle branch active status
     */
    public function toggleStatus(Branch $branch)
    {
        try {
            $branch->update(['is_active' => !$branch->is_active]);
            
            $status = $branch->is_active ? 'à¹€à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™' : 'à¸›à¸´à¸”à¹ƒà¸Šà¹‰à¸‡à¸²à¸™';
            
            return redirect()->back()
                ->with('success', "à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°à¸ªà¸²à¸‚à¸²à¹€à¸›à¹‡à¸™ {$status} à¹€à¸£à¸µà¸¢à¸šà¸£à¹‰à¸­à¸¢à¹à¸¥à¹‰à¸§");

        } catch (\Exception $e) {
            Log::error('Branch Toggle Status Error:', ['error' => $e->getMessage()]);
            return redirect()->back()
                ->with('error', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸ªà¸–à¸²à¸™à¸°');
        }
    }

    /**
     * Get branch data for AJAX
     */
    public function getData(Request $request)
    {
        $query = Branch::with(['manager', 'employees']);

        if ($request->has('search') && $request->search) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('name', 'LIKE', "%{$search}%")
                  ->orWhere('code', 'LIKE', "%{$search}%");
            });
        }

        $branches = $query->get();

        return response()->json([
            'success' => true,
            'data' => $branches
        ]);
    }

    // ========================================
    // âœ… NEW: EXPORT METHODS - à¹à¸à¹‰à¹„à¸‚ Route à¸—à¸µà¹ˆà¸«à¸²à¸¢à¹„à¸›
    // ========================================

    /**
     * âœ… NEW: Export branches to Excel (Default export route)
     */
    public function exportExcel(Request $request)
    {
        $user = Auth::user();
        
        // Check permissions
        if (!$this->canExportBranches($user)) {
            return redirect()->route('branches.index')
                ->with('error', 'à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²');
        }

        try {
            $query = Branch::with(['manager', 'employees']);
            
            // Apply filters if provided
            if ($request->filled('status')) {
                $query->where('is_active', $request->status);
            }
            
            if ($request->filled('search')) {
                $search = $request->search;
                $query->where(function($q) use ($search) {
                    $q->where('name', 'LIKE', "%{$search}%")
                      ->orWhere('code', 'LIKE', "%{$search}%")
                      ->orWhere('address', 'LIKE', "%{$search}%");
                });
            }
            
            $branches = $query->get();
            
            // Format data for export
            $data = $branches->map(function ($branch) {
                return [
                    'à¸£à¸«à¸±à¸ªà¸ªà¸²à¸‚à¸²' => $branch->code,
                    'à¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸²' => $branch->name,
                    'à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ' => $branch->address ?? '-',
                    'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£' => $branch->phone ?? '-',
                    'à¸­à¸µà¹€à¸¡à¸¥' => $branch->email ?? '-',
                    'à¸ˆà¸³à¸™à¸§à¸™à¸à¸™à¸±à¸à¸‡à¸²à¸™' => $branch->employees->count(),
                    'à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸¹à¸‡à¸ªà¸¸à¸”' => $branch->capacity ?? '-',
                    'à¹ƒà¸Šà¹‰à¸à¸³à¸¥à¸±à¸‡à¸à¸²à¸£à¸œà¸¥à¸´à¸•' => $branch->capacity ? $branch->capacity_usage . '%' : '-',
                    'à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£' => $branch->manager_name,
                    'à¸ªà¸–à¸²à¸™à¸°' => $branch->status_display,
                    'à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ' => $branch->formatted_area,
                    'à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢' => $branch->description ?? '-',
                    'à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”' => $branch->opening_date ? $branch->opening_date->format('d/m/Y') : '-',
                    'à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡' => $branch->created_at->format('d/m/Y H:i'),
                ];
            });

            Log::info('ğŸ¢ Branch Export Excel', [
                'exported_by' => $user->id,
                'exported_by_name' => $user->full_name_th ?? $user->name,
                'total_records' => $data->count(),
                'filters' => $request->only(['status', 'search'])
            ]);

            // For now, return JSON. In a real implementation, you'd use Laravel Excel
            return response()->json([
                'success' => true,
                'message' => 'à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²à¸ªà¸³à¸«à¸£à¸±à¸šà¸ªà¹ˆà¸‡à¸­à¸­à¸ Excel',
                'data' => $data,
                'total' => $data->count(),
                'export_url' => 'data:application/json;charset=utf-8,' . urlencode(json_encode($data, JSON_UNESCAPED_UNICODE))
            ]);

        } catch (\Exception $e) {
            Log::error('Branch export Excel failed: ' . $e->getMessage());
            return back()->with('error', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Excel: ' . $e->getMessage());
        }
    }

    /**
     * âœ… NEW: Export branches to PDF
     */
    public function exportPdf(Request $request)
    {
        $user = Auth::user();
        
        if (!$this->canExportBranches($user)) {
            return redirect()->route('branches.index')
                ->with('error', 'à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²');
        }

        try {
            $branches = Branch::with(['manager', 'employees'])->get();
            
            Log::info('ğŸ¢ Branch Export PDF', [
                'exported_by' => $user->id,
                'total_records' => $branches->count()
            ]);

            // TODO: Implement PDF export using DomPDF or similar
            return back()->with('info', 'à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸­à¸­à¸ PDF à¸à¸³à¸¥à¸±à¸‡à¸à¸±à¸’à¸™à¸² - à¹ƒà¸Šà¹‰ Excel à¸Šà¸±à¹ˆà¸§à¸„à¸£à¸²à¸§');

        } catch (\Exception $e) {
            Log::error('Branch export PDF failed: ' . $e->getMessage());
            return back()->with('error', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ PDF');
        }
    }

    /**
     * âœ… NEW: Export branches to CSV
     */
    public function exportCsv(Request $request)
    {
        $user = Auth::user();
        
        if (!$this->canExportBranches($user)) {
            return redirect()->route('branches.index')
                ->with('error', 'à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸—à¸˜à¸´à¹Œà¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ªà¸²à¸‚à¸²');
        }

        try {
            $branches = Branch::with(['manager', 'employees'])->get();
            
            $filename = 'branches_export_' . now()->format('Y-m-d_H-i-s') . '.csv';
            
            $headers = [
                'Content-Type' => 'text/csv; charset=UTF-8',
                'Content-Disposition' => "attachment; filename=\"{$filename}\"",
            ];

            Log::info('ğŸ¢ Branch Export CSV', [
                'exported_by' => $user->id,
                'filename' => $filename,
                'total_records' => $branches->count()
            ]);

            $callback = function() use ($branches) {
                $file = fopen('php://output', 'w');
                
                // Add BOM for UTF-8
                fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));
                
                // CSV Header
                fputcsv($file, [
                    'à¸£à¸«à¸±à¸ªà¸ªà¸²à¸‚à¸²',
                    'à¸Šà¸·à¹ˆà¸­à¸ªà¸²à¸‚à¸²', 
                    'à¸—à¸µà¹ˆà¸­à¸¢à¸¹à¹ˆ',
                    'à¹€à¸šà¸­à¸£à¹Œà¹‚à¸—à¸£',
                    'à¸­à¸µà¹€à¸¡à¸¥',
                    'à¸ˆà¸³à¸™à¸§à¸™à¸à¸™à¸±à¸à¸‡à¸²à¸™',
                    'à¸ˆà¸³à¸™à¸§à¸™à¸ªà¸¹à¸‡à¸ªà¸¸à¸”',
                    'à¹ƒà¸Šà¹‰à¸à¸³à¸¥à¸±à¸‡à¸à¸²à¸£à¸œà¸¥à¸´à¸•(%)',
                    'à¸œà¸¹à¹‰à¸ˆà¸±à¸”à¸à¸²à¸£',
                    'à¸ªà¸–à¸²à¸™à¸°',
                    'à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆ',
                    'à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢',
                    'à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”',
                    'à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸£à¹‰à¸²à¸‡'
                ]);

                // CSV Data
                foreach ($branches as $branch) {
                    fputcsv($file, [
                        $branch->code,
                        $branch->name,
                        $branch->address ?? '',
                        $branch->phone ?? '',
                        $branch->email ?? '',
                        $branch->employees->count(),
                        $branch->capacity ?? '',
                        $branch->capacity ? $branch->capacity_usage : '',
                        $branch->manager_name,
                        $branch->status_display,
                        $branch->area_sqm ?? '',
                        $branch->description ?? '',
                        $branch->opening_date ? $branch->opening_date->format('d/m/Y') : '',
                        $branch->created_at->format('d/m/Y H:i')
                    ]);
                }

                fclose($file);
            };

            return response()->stream($callback, 200, $headers);

        } catch (\Exception $e) {
            Log::error('Branch export CSV failed: ' . $e->getMessage());
            return back()->with('error', 'à¹€à¸à¸´à¸”à¸‚à¹‰à¸­à¸œà¸´à¸”à¸à¸¥à¸²à¸”à¹ƒà¸™à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸­à¸­à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ CSV');
        }
    }

    // ========================================
    // âœ… PERMISSION HELPER METHODS
    // ========================================

    /**
     * Check if user can export branches
     */
    private function canExportBranches($user): bool
    {
        return in_array($user->role, ['super_admin', 'it_admin', 'hr']);
    }

    /**
     * Check if user can view branches
     */
    private function canViewBranches($user): bool
    {
        return in_array($user->role, ['super_admin', 'it_admin', 'hr', 'manager']);
    }

    /**
     * Check if user can create branches
     */
    private function canCreateBranches($user): bool
    {
        return in_array($user->role, ['super_admin', 'it_admin', 'hr']);
    }

    /**
     * Check if user can edit branches
     */
    private function canEditBranches($user): bool
    {
        return in_array($user->role, ['super_admin', 'it_admin', 'hr']);
    }

    /**
     * Check if user can delete branches
     */
    private function canDeleteBranches($user): bool
    {
        return in_array($user->role, ['super_admin', 'it_admin']);
    }
}
